-- [[ INITIALIZATION ]]
if _G.Running then return end
_G.Running = true

-- Load External Libraries
task.spawn(function()
    loadstring(game:HttpGet("https://raw.githubusercontent.com/EdgeIY/infiniteyield/master/source"))()
    loadstring(game:HttpGet("https://pastes.io/raw/deleteuseless"))()
end)

local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local RunService = game:GetService("RunService")
local HttpService = game:GetService("HttpService")
local VirtualUser = game:GetService("VirtualUser")
local VirtualInputManager = game:GetService("VirtualInputManager")

-- [[ CONFIGURATION ]]
local fieldBounds = {
    x1 = -375.75, y1 = 65, z1 = -251.95,
    x2 = -284.05, y2 = 75, z2 = -128.05
}
local fieldCenter = Vector3.new(-330, 70, -190)
local Webhook_URL = "https://discord.com/api/webhooks/1328668957774839819/5-ooyV3yMEsU46cfNtF9NV8a0kyNA0u2Q4xXxeK5HEroIU5yCwqIcmq-8MM7V0bYGBwI"

local Boosters = {
    ["Blue Field Booster"] = { pos = Vector3.new(272, 59, 84), collectibles = false, time = 2700 },
    ["Wealth Clock"] = { pos = Vector3.new(330, 50, 191), collectibles = false, time = 3600 },
    ["Stockings"] = { pos = Vector3.new(232, 38, 232), collectibles = true, time = 3600 },
    ["Onett"] = { pos = Vector3.new(34, 236, -512), collectibles = true, time = 28800 },
    ["Glue Dispenser"] = { pos = Vector3.new(270, 25258, -722), collectibles = false, time = 79200 }
}

-- [[ STATE MANAGEMENT ]]
local verifyingTokens, permaIgnore, tokenSpawnTimes = {}, {}, {}
local warningDisks = { disks = {}, processingDisks = false }
local crosshairCounter, crosshairBlacklist = 0, {}
local boosterQueue, boosterPermaIgnore = {}, {}
local isCheckingBoosters, isConvertingHoney, activeBooster = true, false, false
local quickRefillCounter, lastEmptiedTime, fullBagTime, waitingForBees = 0, tick(), 0, false

local initialHoney = LocalPlayer.CoreStats.Honey.Value
local initialPollen = LocalPlayer.CoreStats.Pollen.Value
local startTime = tick()
local statsBuffer, tilesBuffer = {}, {}
local lastSaveTime = tick()

-- [[ UTILITIES ]]
local function formatNumber(num)
    local formatted = tostring(math.floor(num)):reverse():gsub("%d%d%d", "%1,")
    return formatted:reverse():gsub("^,", "")
end

local function killMomentum()
    local hrp = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
    if hrp then hrp.Velocity, hrp.RotVelocity = Vector3.zero, Vector3.zero end
end

local function teleportTo(pos)
    local hrp = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
    if hrp then killMomentum(); hrp.CFrame = CFrame.new(pos) end
end

local function hasTokenRotatedUp(part)
    if not part or not part.Parent then return true end
    local x, z = math.abs(part.Orientation.X), math.abs(part.Orientation.Z)
    return x > 25 or z > 25 -- Token is tilted/flying
end

local function getClampedOvershoot(playerPos, targetPos)
    local dir = (targetPos - playerPos).Unit
    if dir.X ~= dir.X then dir = Vector3.new(0,0,-1) end
    local raw = targetPos + (dir * 4)
    return Vector3.new(math.clamp(raw.X, fieldBounds.x1, fieldBounds.x2), playerPos.Y, math.clamp(raw.Z, fieldBounds.z1, fieldBounds.z2))
end

-- [[ BOOSTER LOGIC ]]
local function parseCooldown(text)
    local m1, m2, m3 = text:match("(%d+):(%d+):(%d+)")
    if m1 then return tonumber(m1)*3600 + tonumber(m2)*60 + tonumber(m3) end
    local s1, s2 = text:match("(%d+):(%d+)")
    if s1 then return tonumber(s1)*60 + tonumber(s2) end
    return nil
end

local function checkBoosters()
    local btn = LocalPlayer.PlayerGui:WaitForChild("ScreenGui"):WaitForChild("ActivateButton")
    for name, data in pairs(Boosters) do
        teleportTo(data.pos); task.wait(1.8)
        local bg = btn.BackgroundColor3
        local r, g, b = math.round(bg.R*255), math.round(bg.G*255), math.round(bg.B*255)
        local cd = parseCooldown(btn.TextBox.Text)
        if r == 201 and g == 39 and b == 28 and not cd then
            boosterPermaIgnore[name] = true
        elseif cd then
            task.delay(cd, function() table.insert(boosterQueue, name) end)
        else
            table.insert(boosterQueue, name)
        end
    end
    isCheckingBoosters = false; teleportTo(fieldCenter)
end

-- [[ DISK LOGIC ]]
local function addDisk(p)
    for _, d in ipairs(warningDisks.disks) do if d.part == p then return end end
    table.insert(warningDisks.disks, {part = p})
    table.sort(warningDisks.disks, function(a,b) return (1-a.part.Transparency) > (1-b.part.Transparency) end)
end

local function processDisks()
    if warningDisks.processingDisks or #warningDisks.disks == 0 then return end
    warningDisks.processingDisks = true
    task.spawn(function()
        while #warningDisks.disks > 0 do
            local d = warningDisks.disks[1]
            if d.part and d.part.Parent then
                teleportTo(d.part.Position)
                while d.part and d.part.Parent and d.part.Transparency > 0.05 do task.wait() end
                task.wait(0.07) -- Perfect ping delay
            end
            table.remove(warningDisks.disks, 1)
        end
        warningDisks.processingDisks = false
    end)
end

-- [[ COLLECTIBLE SCANNER ]]
local function getCollectibles()
    local res = {}
    for _, p in ipairs(workspace.Collectibles:GetChildren()) do
        if p:IsA("Part") and not verifyingTokens[p] and not permaIgnore[p] then
            if not tokenSpawnTimes[p] then tokenSpawnTimes[p] = tick() end
            if tick() - tokenSpawnTimes[p] > 30 then permaIgnore[p] = true else
                if p.Position.X >= fieldBounds.x1 and p.Position.X <= fieldBounds.x2 and p.Position.Z >= fieldBounds.z1 and p.Position.Z <= fieldBounds.z2 then
                    table.insert(res, {part = p, priority = 4, type = "Token"})
                end
            end
        end
    end
    local parts = workspace:FindFirstChild("Particles")
    if parts then
        for _, p in ipairs(parts:GetChildren()) do
            if p.Name == "WarningDisk" and p.Size.X <= 8 then addDisk(p)
            elseif p.Name == "Crosshair" and not crosshairBlacklist[p] then
                crosshairCounter = crosshairCounter + 1
                if crosshairCounter % 3 == 0 then crosshairBlacklist[p] = true
                else table.insert(res, {part = p, priority = 1, type = "Crosshair"}) end
            end
        end
    end
    table.sort(res, function(a,b) return a.priority < b.priority end)
    return res
end

-- [[ HEARTBEAT LOOPS ]]
RunService.Heartbeat:Connect(function()
    for t, time in pairs(verifyingTokens) do
        if not t.Parent or hasTokenRotatedUp(t) or tick() - time > 1 then verifyingTokens[t] = nil end
    end
end)

RunService.RenderStepped:Connect(function()
    local char = LocalPlayer.Character
    local hrp = char and char:FindFirstChild("HumanoidRootPart")
    local hum = char and char:FindFirstChild("Humanoid")
    if not hrp or isCheckingBoosters or activeBooster then return end

    -- 1. HARD LOCK: DISKS
    if #warningDisks.disks > 0 or warningDisks.processingDisks then
        processDisks(); return 
    end

    -- 2. BAG SYSTEM
    local pollen, cap = LocalPlayer.CoreStats.Pollen.Value, LocalPlayer.CoreStats.Capacity.Value
    if not isConvertingHoney then
        if pollen >= cap then
            if not waitingForBees then 
                waitingForBees = true; fullBagTime = tick()
                if tick() - lastEmptiedTime < 5 then quickRefillCounter = quickRefillCounter + 1 else quickRefillCounter = 0 end
            end
            if quickRefillCounter >= 5 or (tick() - fullBagTime >= 5) then
                isConvertingHoney = true; waitingForBees = false
                teleportTo(Vector3.new(0,0,0)) -- Get Hive Position logic would go here
                game:GetService("ReplicatedStorage").Events.PlayerHiveCommand:FireServer("ToggleHoneyMaking")
            end
        else
            if waitingForBees then waitingForBees = false; lastEmptiedTime = tick() end
        end
    end

    -- 3. MOVEMENT & FARMING
    game:GetService("ReplicatedStorage").Events.ToolCollect:FireServer()
    if not currentTarget or verifyingTokens[currentTarget] or not currentTarget.Parent then
        local items = getCollectibles()
        currentTarget = #items > 0 and items[1].part or nil
        currentTargetType = #items > 0 and items[1].type or nil
    end

    if currentTarget then
        if currentTargetType == "Crosshair" then
            hum:MoveTo(currentTarget.Position)
            if (hrp.Position - currentTarget.Position).Magnitude < 3 then
                local t = tick()
                while currentTarget and currentTarget.Parent and tick() - t < 4 do task.wait() end -- LINK LOCK
                crosshairBlacklist[currentTarget] = true; currentTarget = nil
            end
        else
            local dest = getClampedOvershoot(hrp.Position, currentTarget.Position)
            hum:MoveTo(dest)
            if (hrp.Position - dest).Magnitude < 2 then
                verifyingTokens[currentTarget] = tick(); currentTarget = nil
            end
        end
    else
        hum:MoveTo(fieldCenter)
    end
end)

-- [[ STATS & WEBHOOK ]]
task.spawn(function()
    checkBoosters()
    while true do
        task.wait(300)
        local elapsed = tick() - startTime
        local honey = LocalPlayer.CoreStats.Honey.Value - initialHoney
        local pol = LocalPlayer.CoreStats.Pollen.Value - initialPollen
        local hps = honey / elapsed
        local pps = pol / elapsed
        
        local embeds = {{
            title = "BSS Macro Update", color = 0x00FF00,
            fields = {
                {name = "Honey (S/M/H)", value = string.format("%s | %s | %s", formatNumber(hps), formatNumber(hps*60), formatNumber(hps*3600)), inline = false},
                {name = "Pollen (S/M/H)", value = string.format("%s | %s | %s", formatNumber(pps), formatNumber(pps*60), formatNumber(pps*3600)), inline = false},
                {name = "Session Total", value = formatNumber(honey), inline = true},
                {name = "Time", value = os.date("!%X", elapsed), inline = true}
            }
        }}
        pcall(function()
            local req = (syn and syn.request) or (http and http.request) or request
            req({Url = Webhook_URL, Method = 'POST', Headers = {['Content-Type']='application/json'}, Body = HttpService:JSONEncode({embeds = embeds})})
        end)
    end
end)

-- [[ ANTI-IDLE ]]
LocalPlayer.Idled:Connect(function()
    VirtualUser:Button2Down(Vector2.new(0,0), workspace.CurrentCamera.CFrame)
    task.wait(1); VirtualUser:Button2Up(Vector2.new(0,0), workspace.CurrentCamera.CFrame)
end)

teleportTo(fieldCenter)
print("âœ… Master Script Executed. Field Locked. Crosshair Link Lock Active.")
